<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengkel Pro - Master Final V15.14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 90px; background: #f4f7fa; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; display: flex; background: #fff; border-top: 2px solid #ddd; z-index: 1000; }
        .nav-btn { flex: 1; padding: 12px 5px; text-align: center; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; }
        .nav-btn.active { color: #2563eb; border-top: 4px solid #2563eb; background: #f8fafc; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        input, select, textarea { border: 1px solid #ccc; padding: 10px; border-radius: 4px; width: 100%; font-size: 14px; }
        .grid-item { display: grid; grid-template-columns: 2fr 2fr 1.5fr 0.8fr 1.5fr 40px; gap: 5px; margin-bottom: 8px; align-items: center; }

        @media print {
            @page { size: A5 landscape; margin: 0.5cm; }
            body { padding: 0; background: white; }
            .no-print, .nav-bottom, button, .bg-blue-900, .view { display: none !important; }
            #print-area { display: block !important; width: 100%; visibility: visible; }
            .header-nota { margin-top: -10px; margin-bottom: 5px; border-bottom: 2px solid black; padding-bottom: 5px; }
            table { width: 100% !important; border-collapse: collapse !important; margin-top: 5px; }
            th, td { border: 1px solid black !important; padding: 4px 6px !important; color: black !important; font-size: 11px !important; visibility: visible !important; }
            .no-print-wo { display: none !important; } /* Hanya aktif jika tipe WO */
            .cat-row td { background: #f0f0f0 !important; font-weight: bold !important; text-align: center !important; }
        }

        .table-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #ddd; }
        #table-riwayat { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1200px; }
        #table-riwayat th, #table-riwayat td { border: 1px solid #eee; padding: 10px; }
    </style>
</head>
<body>

<div class="bg-blue-900 text-white p-4 sticky top-0 flex justify-between items-center no-print z-50">
    <h1 id="disp-nama" class="font-bold uppercase italic text-xl">BENGKEL PRO</h1>
    <div class="text-[9px] bg-green-600 px-2 py-1 rounded uppercase font-bold">V15.14 FINAL</div>
</div>

<div class="p-4 no-print">
    <div id="menu-nota" class="view">
        <div class="card">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="in-tipe" class="font-bold text-blue-700 bg-blue-50">
                    <option value="NOTA">NOTA (OMZET)</option>
                    <option value="WO">WORKING ORDER</option>
                    <option value="ESTIMASI">ESTIMASI</option>
                </select>
                <input type="text" id="in-nota" readonly class="bg-gray-100 font-bold text-center">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" id="in-tgl">
                <input type="text" id="in-nopol" placeholder="NO POLISI" class="uppercase font-bold text-center border-2 border-blue-200">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="in-nama" placeholder="NAMA PELANGGAN (UNTUK RIWAYAT)">
                <input type="text" id="in-merk" placeholder="MERK MOBIL">
            </div>
            <input type="number" id="in-km" placeholder="KILOMETER (KM)">
        </div>

        <div class="card">
            <div id="item-list" oninput="recalc()">
                <div class="grid-item text-[10px] font-black text-blue-900 uppercase mb-2 border-b pb-1 text-center">
                    <div>Jasa</div><div>Sparepart</div><div>Harga</div><div>Qty</div><div>Total</div><div></div>
                </div>
            </div>
            <button onclick="addItemRow()" class="text-blue-600 font-bold text-xs mt-2">+ TAMBAH ITEM</button>
            <textarea id="in-catatan" rows="2" placeholder="Catatan/Keluhan..." class="mt-4 text-xs w-full"></textarea>
            <div class="mt-4 p-4 bg-slate-900 text-white rounded flex justify-between items-center shadow-lg">
                <span class="text-xs font-bold opacity-70 italic">Grand Total</span>
                <span id="grand-total" class="text-2xl font-mono text-green-400 font-bold">0</span>
            </div>
        </div>
        <button onclick="prosesTransaksi()" class="w-full bg-blue-700 text-white py-4 rounded-xl font-black shadow-lg">SIMPAN & CETAK</button>
    </div>

    <div id="menu-antrean" class="view hidden">
        <div id="list-antrean" class="space-y-2"></div>
    </div>

    <div id="menu-riwayat" class="view hidden">
        <input type="text" id="f-search" placeholder="Cari Nopol / Nota..." oninput="renderRiwayat()" class="w-full mb-2">
        <div class="table-container">
            <table id="table-riwayat">
                <thead><tr class="bg-gray-100"><th>Tgl</th><th>Nota</th><th>Nopol</th><th>KM</th><th>Merk</th><th>Nama</th><th>Jasa</th><th>Part</th><th>Harga</th><th>Qty</th><th>Total</th></tr></thead>
                <tbody id="tbody-riwayat"></tbody>
            </table>
        </div>
    </div>

    <div id="menu-laporan" class="view hidden">
        <div id="box-laporan" class="space-y-4"></div>
    </div>

    <div id="menu-setting" class="view hidden">
        <div class="card space-y-2">
            <input type="text" id="s-nama" placeholder="Nama Bengkel">
            <input type="text" id="s-alamat" placeholder="Alamat">
            <input type="text" id="s-hp" placeholder="No HP">
            <input type="text" id="s-owner" placeholder="Owner">
            <input type="text" id="s-rek" placeholder="Rekening">
            <div class="grid grid-cols-2 gap-2"><input type="text" id="s-prefix"><input type="number" id="s-next-no"></div>
            <input type="text" id="s-gsheet" placeholder="URL G-Sheet">
            <button onclick="saveSettings()" class="w-full bg-slate-800 text-white py-3 rounded font-bold uppercase text-xs">Simpan Pengaturan</button>
        </div>
        <div class="card grid grid-cols-2 gap-2">
            <button onclick="exportData()" class="bg-green-600 text-white py-2 rounded text-[10px] font-bold">EXPORT JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="bg-orange-500 text-white py-2 rounded text-[10px] font-bold">IMPORT JSON</button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
        </div>
        <button onclick="resetData()" class="text-red-500 text-[10px] mt-8 block w-full text-center underline opacity-50">Hapus Data Lokal</button>
    </div>
</div>

<div id="print-area" class="hidden p-4 text-black">
    <div class="header-nota text-center">
        <h2 id="p-toko" class="text-xl font-bold uppercase"></h2>
        <p id="p-alamat-toko" class="text-[10px]"></p>
        <p id="p-hp-toko" class="text-[10px] font-bold"></p>
    </div>
    <div class="flex justify-between my-2 text-[11px]">
        <div>
            <p>Unit: <span id="p-unit" class="font-bold"></span></p>
            <p>Nopol: <span id="p-nopol" class="font-bold"></span></p>
            <p>KM: <span id="p-km" class="font-bold"></span></p>
        </div>
        <div class="text-right">
            <p id="p-label-tipe" class="font-bold italic underline text-sm"></p>
            <p>No: <span id="p-no" class="font-bold"></span></p>
            <p>Tgl: <span id="p-tgl"></span></p>
        </div>
    </div>
    
    <table class="w-full">
        <thead>
            <tr class="bg-gray-200">
                <th class="text-left" style="width: 45%;">URAIAN PEKERJAAN / PART</th>
                <th class="text-right p-harga-col" style="width: 20%;">HARGA (Rp)</th>
                <th class="text-center" style="width: 10%;">QTY</th>
                <th class="text-right p-harga-col" style="width: 25%;">SUBTOTAL (Rp)</th>
            </tr>
        </thead>
        <tbody id="p-body">
            </tbody>
        <tfoot id="p-foot-total">
            <tr class="font-bold border-t-2 border-black">
                <td colspan="3" class="text-right p-2 uppercase">Grand Total (Rp)</td>
                <td class="text-right p-2" id="p-total"></td>
            </tr>
        </tfoot>
    </table>

    <div class="text-[10px] mt-2">Catatan: <span id="p-cat" class="italic"></span></div>
    <div id="p-box-rek" class="text-[10px] mt-1">Pembayaran Transfer: <span id="p-rek" class="font-bold"></span></div>
    
    <div class="flex justify-between text-center mt-6 text-[11px]">
        <div class="w-32 border-t border-black pt-1">Hormat Kami,<br><br>( <span id="p-owner"></span> )</div>
        <div class="w-32 border-t border-black pt-1">Pelanggan,<br><br>( ............ )</div>
    </div>
</div>

<nav class="nav-bottom no-print">
    <div class="nav-btn active" onclick="showView('nota', this)">ENTRY</div>
    <div class="nav-btn" onclick="showView('antrean', this)">ANTREAN</div>
    <div class="nav-btn" onclick="showView('riwayat', this)">RIWAYAT</div>
    <div class="nav-btn" onclick="showView('laporan', this)">LAPORAN</div>
    <div class="nav-btn" onclick="showView('setting', this)">SETTING</div>
</nav>

<script>
    const KEY = "BENGKEL_PRO_V1514_MASTER";
    let db = JSON.parse(localStorage.getItem(KEY)) || { settings: { gsheet: "", nama: "BENGKEL PRO", rek: "", prefix: "DK-", nextNo: 1, alamat: "", hp: "", owner: "" }, transaksi: [], antrean: [] };

    function init() {
        document.getElementById('in-tgl').valueAsDate = new Date();
        const s = db.settings;
        document.getElementById('disp-nama').innerText = s.nama;
        document.getElementById('s-nama').value = s.nama;
        document.getElementById('s-alamat').value = s.alamat;
        document.getElementById('s-hp').value = s.hp;
        document.getElementById('s-owner').value = s.owner;
        document.getElementById('s-rek').value = s.rek;
        document.getElementById('s-prefix').value = s.prefix;
        document.getElementById('s-next-no').value = s.nextNo;
        document.getElementById('s-gsheet').value = s.gsheet;
        updateNotaDisplay();
        addItemRow();
    }

    function updateNotaDisplay() {
        document.getElementById('in-nota').value = db.settings.prefix + String(db.settings.nextNo).padStart(3, '0');
    }

    function addItemRow(data = {j:'', p:'', h:0, q:1}) {
        const div = document.createElement('div'); div.className = "grid-item item-row";
        div.innerHTML = `<input type="text" class="i-jasa" value="${data.j}" placeholder="Jasa"><input type="text" class="i-part" value="${data.p}" placeholder="Part"><input type="number" class="i-price" value="${data.h}"><input type="number" class="i-qty" value="${data.q}"><input type="text" readonly class="i-sub bg-gray-50 text-right font-bold" value="0"><button onclick="this.parentElement.remove(); recalc()" class="text-red-500 font-bold">×</button>`;
        document.getElementById('item-list').appendChild(div);
        recalc();
    }

    function recalc() {
        let grand = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            const sub = h * q;
            row.querySelector('.i-sub').value = sub.toLocaleString('id-ID');
            grand += sub;
        });
        document.getElementById('grand-total').innerText = grand.toLocaleString('id-ID');
    }

    function prosesTransaksi() {
        const tipe = document.getElementById('in-tipe').value;
        const nopol = document.getElementById('in-nopol').value.toUpperCase();
        if(!nopol) return alert("Nopol Wajib Diisi!");

        let jasa = []; let part = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const j = row.querySelector('.i-jasa').value;
            const p = row.querySelector('.i-part').value;
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            if(j) jasa.push({n:j, h, q, s:h*q});
            if(p) part.push({n:p, h, q, s:h*q});
        });

        // GENERATE HTML TABEL CETAK (PASTIKAN HARGA ADA)
        let htmlContent = "";
        const isWO = (tipe === "WO");

        if(jasa.length > 0){
            htmlContent += `<tr class="cat-row"><td colspan="4">--- JASA / SERVICE ---</td></tr>`;
            jasa.forEach(i => {
                htmlContent += `<tr>
                    <td>${i.n}</td>
                    <td class="text-right ${isWO ? 'hidden' : ''}">${i.h.toLocaleString('id-ID')}</td>
                    <td class="text-center">${i.q}</td>
                    <td class="text-right ${isWO ? 'hidden' : ''}">${i.s.toLocaleString('id-ID')}</td>
                </tr>`;
            });
        }
        if(part.length > 0){
            htmlContent += `<tr class="cat-row"><td colspan="4">--- SPAREPART / OLI ---</td></tr>`;
            part.forEach(i => {
                htmlContent += `<tr>
                    <td>${i.n}</td>
                    <td class="text-right ${isWO ? 'hidden' : ''}">${i.h.toLocaleString('id-ID')}</td>
                    <td class="text-center">${i.q}</td>
                    <td class="text-right ${isWO ? 'hidden' : ''}">${i.s.toLocaleString('id-ID')}</td>
                </tr>`;
            });
        }

        // Tampilkan/Sembunyikan Kolom Harga
        const priceCols = document.querySelectorAll('.p-harga-col');
        priceCols.forEach(col => col.style.display = isWO ? 'none' : 'table-cell');
        document.getElementById('p-foot-total').style.display = isWO ? 'none' : 'table-footer-group';
        document.getElementById('p-box-rek').style.display = isWO ? 'none' : 'block';

        const s = db.settings;
        document.getElementById('p-toko').innerText = s.nama;
        document.getElementById('p-alamat-toko').innerText = s.alamat;
        document.getElementById('p-hp-toko').innerText = "WhatsApp: " + s.hp;
        document.getElementById('p-owner').innerText = s.owner;
        document.getElementById('p-rek').innerText = s.rek;
        document.getElementById('p-label-tipe').innerText = tipe;
        document.getElementById('p-unit').innerText = document.getElementById('in-merk').value;
        document.getElementById('p-nopol').innerText = nopol;
        document.getElementById('p-km').innerText = document.getElementById('in-km').value;
        document.getElementById('p-no').innerText = document.getElementById('in-nota').value;
        document.getElementById('p-tgl').innerText = document.getElementById('in-tgl').value;
        document.getElementById('p-cat').innerText = document.getElementById('in-catatan').value;
        document.getElementById('p-body').innerHTML = htmlContent;
        document.getElementById('p-total').innerText = document.getElementById('grand-total').innerText;

        const common = { tgl: document.getElementById('in-tgl').value, noTrx: document.getElementById('in-nota').value, nopol, km: document.getElementById('in-km').value, merk: document.getElementById('in-merk').value, nama: document.getElementById('in-nama').value, catatan: document.getElementById('in-catatan').value };

        if(tipe === "NOTA") {
            jasa.forEach(i => db.transaksi.push({...common, uraian: i.n, sparepart: "", harga: i.h, qty: i.q, jumlah: i.s}));
            part.forEach(i => db.transaksi.push({...common, uraian: "", sparepart: i.n, harga: i.h, qty: i.q, jumlah: i.s}));
            db.settings.nextNo++;
            if(s.gsheet) fetch(s.gsheet, { method: 'POST', mode: 'no-cors', body: JSON.stringify(db.transaksi[db.transaksi.length-1]) });
        } else {
            db.antrean.push({...common, items: [...jasa.map(x=>({j:x.n, p:"", h:x.h, q:x.q})), ...part.map(x=>({j:"", p:x.n, h:x.h, q:x.q}))], tipe, total: document.getElementById('grand-total').innerText });
        }

        localStorage.setItem(KEY, JSON.stringify(db));
        window.print();
        setTimeout(() => location.reload(), 500);
    }

    function renderRiwayat() {
        const s = document.getElementById('f-search').value.toLowerCase();
        const f = db.transaksi.filter(x => (x.nopol + x.noTrx).toLowerCase().includes(s));
        document.getElementById('tbody-riwayat').innerHTML = f.slice().reverse().map(x => `<tr><td>${x.tgl}</td><td>${x.noTrx}</td><td>${x.nopol}</td><td>${x.km}</td><td>${x.merk}</td><td>${x.nama}</td><td>${x.uraian}</td><td>${x.sparepart}</td><td>${(x.harga||0).toLocaleString()}</td><td>${x.qty}</td><td>${(x.jumlah||0).toLocaleString()}</td></tr>`).join('');
    }

    function renderLaporan() {
        const j = db.transaksi.filter(x => x.uraian).reduce((a,c) => a + (c.jumlah||0), 0);
        const p = db.transaksi.filter(x => x.sparepart).reduce((a,c) => a + (c.jumlah||0), 0);
        document.getElementById('box-laporan').innerHTML = `<div class="card border-l-8 border-blue-600"><p class="text-[10px] font-bold">JASA</p><h2 class="text-2xl font-black">Rp ${j.toLocaleString()}</h2></div><div class="card border-l-8 border-green-600"><p class="text-[10px] font-bold">PART</p><h2 class="text-2xl font-black">Rp ${p.toLocaleString()}</h2></div><div class="card bg-slate-900 text-white"><p class="text-[10px] opacity-70 uppercase font-bold">Total Omzet</p><h2 class="text-3xl font-black text-green-400">Rp ${(j+p).toLocaleString()}</h2></div>`;
    }

    function renderAntrean() {
        document.getElementById('list-antrean').innerHTML = db.antrean.map(x => `<div class="card flex justify-between items-center border-l-4 border-orange-500"><div><b class="text-blue-700">${x.nopol}</b> - ${x.merk}<br><small>${x.tipe} | Total: ${x.total}</small></div><div class="flex gap-2"><button onclick="loadAntrean('${x.noTrx}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold uppercase">PROSES</button><button onclick="hapusAntrean('${x.noTrx}')" class="text-red-500 font-bold">×</button></div></div>`).join('') || '<p class="text-center italic text-gray-400">Antrean Kosong</p>';
    }

    function loadAntrean(no) {
        const x = db.antrean.find(i => i.noTrx === no); if(!x) return;
        document.getElementById('in-nopol').value = x.nopol;
        document.getElementById('in-merk').value = x.merk;
        document.getElementById('in-km').value = x.km;
        document.getElementById('in-nama').value = x.nama || "";
        document.getElementById('in-catatan').value = x.catatan;
        document.getElementById('item-list').innerHTML = '<div class="grid-item text-[10px] font-black text-blue-900 uppercase mb-2 border-b pb-1 text-center"><div>Jasa</div><div>Part</div><div>Harga</div><div>Qty</div><div>Total</div><div></div></div>';
        x.items.forEach(it => addItemRow({j: it.j, p: it.p, h: it.h, q: it.q}));
        db.antrean = db.antrean.filter(i => i.noTrx !== no);
        localStorage.setItem(KEY, JSON.stringify(db));
        showView('nota', document.querySelectorAll('.nav-btn')[0]);
    }

    function saveSettings() {
        db.settings = { nama: document.getElementById('s-nama').value.toUpperCase(), alamat: document.getElementById('s-alamat').value, hp: document.getElementById('s-hp').value, owner: document.getElementById('s-owner').value, rek: document.getElementById('s-rek').value, prefix: document.getElementById('s-prefix').value, nextNo: parseInt(document.getElementById('s-next-no').value) || 1, gsheet: document.getElementById('s-gsheet').value };
        localStorage.setItem(KEY, JSON.stringify(db)); alert("Saved!"); location.reload();
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `backup_bengkel_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }

    function importData(event) {
        const f = event.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = (e) => { db = JSON.parse(e.target.result); localStorage.setItem(KEY, JSON.stringify(db)); location.reload(); }; r.readAsText(f);
    }

    function showView(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.add('hidden'));
        document.getElementById('menu-' + v).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(v === 'antrean') renderAntrean();
        if(v === 'riwayat') renderRiwayat();
        if(v === 'laporan') renderLaporan();
    }

    function resetData() { if(confirm("Hapus Permanen?")) { localStorage.clear(); location.reload(); } }
    function hapusAntrean(no) { if(confirm("Hapus?")) { db.antrean = db.antrean.filter(i => i.noTrx !== no); localStorage.setItem(KEY, JSON.stringify(db)); renderAntrean(); } }

    init();
</script>
</body>
</html>
