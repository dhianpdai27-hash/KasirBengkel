<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengkel Pro - Master V15.22</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 90px; background: #f4f7fa; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; display: flex; background: #fff; border-top: 2px solid #ddd; z-index: 1000; }
        .nav-btn { flex: 1; padding: 12px 5px; text-align: center; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; }
        .nav-btn.active { color: #2563eb; border-top: 4px solid #2563eb; background: #f8fafc; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        input, select, textarea { border: 1px solid #ccc; padding: 10px; border-radius: 4px; width: 100%; font-size: 14px; }
        .grid-item { display: grid; grid-template-columns: 2fr 2fr 1.5fr 0.8fr 1.5fr 40px; gap: 5px; margin-bottom: 8px; align-items: center; }

        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { padding: 0; background: white; height: auto; }
            .no-print, .nav-bottom, button, .bg-blue-900, .view { display: none !important; }
            #print-area { display: block !important; width: 100%; visibility: visible; }
            .header-nota { border-bottom: 3px solid black; padding-bottom: 8px; margin-bottom: 10px; }
            table { width: 100% !important; border-collapse: collapse !important; margin-top: 10px; }
            th, td { border: 1px solid black !important; padding: 8px !important; font-size: 14px !important; color: black !important; }
            .text-sm-print { font-size: 13px !important; }
            .text-lg-print { font-size: 18px !important; }
            .cat-row td { background: #f2f2f2 !important; font-weight: bold !important; text-align: center !important; }
        }

        .table-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #ddd; }
        #table-riwayat { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1300px; }
        #table-riwayat th, #table-riwayat td { border: 1px solid #eee; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="bg-blue-900 text-white p-4 sticky top-0 flex justify-between items-center no-print z-50">
    <h1 id="disp-nama" class="font-bold uppercase italic text-xl">BENGKEL PRO</h1>
    <div class="text-[9px] bg-green-600 px-2 py-1 rounded uppercase font-bold">V15.22 FINAL</div>
</div>

<div class="p-4 no-print">
    <div id="menu-nota" class="view">
        <div class="card">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="in-tipe" class="font-bold text-blue-700 bg-blue-50">
                    <option value="NOTA">NOTA (OMZET)</option>
                    <option value="WO">WORKING ORDER</option>
                    <option value="ESTIMASI">ESTIMASI</option>
                </select>
                <input type="text" id="in-nota" readonly class="bg-gray-100 font-bold text-center">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" id="in-tgl">
                <input type="text" id="in-nopol" placeholder="NO POLISI" class="uppercase font-bold text-center border-2 border-blue-200">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="in-nama" placeholder="NAMA PELANGGAN">
                <input type="text" id="in-merk" placeholder="MERK MOBIL">
            </div>
            <input type="number" id="in-km" placeholder="KILOMETER (KM)">
        </div>

        <div class="card">
            <div id="item-list" oninput="recalc()">
                <div class="grid-item text-[10px] font-black text-blue-900 uppercase mb-2 border-b pb-1 text-center">
                    <div>Jasa</div><div>Part</div><div>Harga</div><div>Qty</div><div>Total</div><div></div>
                </div>
            </div>
            <button onclick="addItemRow()" class="text-blue-600 font-bold text-xs mt-2">+ TAMBAH ITEM</button>
            <textarea id="in-catatan" rows="2" placeholder="Catatan/Keluhan..." class="mt-4 text-xs w-full"></textarea>
            <div class="mt-4 p-4 bg-slate-900 text-white rounded flex justify-between items-center">
                <span id="grand-total" class="text-2xl font-mono text-green-400 font-bold">0</span>
            </div>
        </div>
        <button onclick="prosesTransaksi()" class="w-full bg-blue-700 text-white py-4 rounded-xl font-black shadow-lg uppercase">Simpan & Cetak</button>
    </div>

    <div id="menu-antrean" class="view hidden">
        <div id="list-antrean" class="space-y-2"></div>
    </div>

    <div id="menu-riwayat" class="view hidden">
        <input type="text" id="f-search" placeholder="Cari..." oninput="renderRiwayat()" class="w-full mb-2">
        <div class="table-container">
            <table id="table-riwayat">
                <thead><tr class="bg-gray-100"><th>Tgl</th><th>Nota</th><th>Nopol</th><th>KM</th><th>Merk</th><th>Nama</th><th>Jasa</th><th>Part</th><th>Harga</th><th>Qty</th><th>Total</th><th>Catatan</th></tr></thead>
                <tbody id="tbody-riwayat"></tbody>
            </table>
        </div>
    </div>

    <div id="menu-laporan" class="view hidden">
        <div id="box-laporan" class="space-y-4"></div>
    </div>

    <div id="menu-setting" class="view hidden">
        <div class="card space-y-2">
            <input type="text" id="s-nama" placeholder="Nama Bengkel">
            <input type="text" id="s-alamat" placeholder="Alamat">
            <input type="text" id="s-hp" placeholder="No HP">
            <input type="text" id="s-owner" placeholder="Owner">
            <input type="text" id="s-rek" placeholder="Rekening">
            <div class="grid grid-cols-2 gap-2"><input type="text" id="s-prefix"><input type="number" id="s-next-no"></div>
            <input type="text" id="s-gsheet" placeholder="URL G-Sheet">
            <button onclick="saveSettings()" class="w-full bg-slate-800 text-white py-3 rounded font-bold uppercase text-xs">Simpan Pengaturan</button>
        </div>
        <div class="card grid grid-cols-2 gap-2">
            <button onclick="exportData()" class="bg-green-600 text-white py-2 rounded text-[10px] font-bold uppercase">Export JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="bg-orange-500 text-white py-2 rounded text-[10px] font-bold uppercase">Import JSON</button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
        </div>
        <button onclick="resetData()" class="text-red-500 text-[10px] mt-8 block w-full text-center underline opacity-50">Hapus Data Lokal</button>
    </div>
</div>

<div id="print-area" class="hidden">
    <div class="header-nota text-center">
        <h2 id="p-toko" class="text-3xl font-bold uppercase"></h2>
        <p id="p-alamat-toko" class="text-sm-print"></p>
        <p id="p-hp-toko" class="text-sm-print font-bold"></p>
    </div>
    <div class="flex justify-between my-4 text-sm-print">
        <div>
            <p>Unit: <span id="p-unit" class="font-bold"></span></p>
            <p>No. Polisi: <span id="p-nopol" class="font-bold"></span></p>
            <p>KM: <span id="p-km" class="font-bold"></span></p>
        </div>
        <div class="text-right">
            <p id="p-label-tipe" class="font-bold italic underline uppercase text-lg-print"></p>
            <p>No: <span id="p-no" class="font-bold"></span></p>
            <p>Tgl: <span id="p-tgl"></span></p>
        </div>
    </div>
    <table class="w-full">
        <thead><tr class="bg-gray-100"><th>URAIAN</th><th class="p-harga-col">HARGA</th><th>QTY</th><th class="p-harga-col">SUBTOTAL</th></tr></thead>
        <tbody id="p-body"></tbody>
        <tfoot id="p-foot-total"><tr class="font-bold"><td colspan="3" class="text-right p-3">GRAND TOTAL (Rp)</td><td class="text-right p-3" id="p-total"></td></tr></tfoot>
    </table>
    <div class="text-sm-print mt-6">Catatan: <span id="p-cat" class="italic font-bold"></span></div>
    <div id="p-box-rek" class="text-sm-print mt-1">Pembayaran: <span id="p-rek" class="font-bold"></span></div>
    <div class="mt-12"><div class="w-64 text-center"><p class="text-sm-print mb-20">Hormat Kami,</p><p class="border-t border-black font-bold uppercase pt-1 text-sm-print">( <span id="p-owner"></span> )</p></div></div>
</div>

<nav class="nav-bottom no-print">
    <div class="nav-btn active" onclick="showView('nota', this)">ENTRY</div>
    <div class="nav-btn" onclick="showView('antrean', this)">ANTREAN</div>
    <div class="nav-btn" onclick="showView('riwayat', this)">RIWAYAT</div>
    <div class="nav-btn" onclick="showView('laporan', this)">LAPORAN</div>
    <div class="nav-btn" onclick="showView('setting', this)">SETTING</div>
</nav>

<script>
    const KEY = "BENGKEL_PRO_V1522_FINAL";
    let db = JSON.parse(localStorage.getItem(KEY)) || { settings: { gsheet: "", nama: "BENGKEL PRO", rek: "", prefix: "DK-", nextNo: 1, alamat: "", hp: "", owner: "" }, transaksi: [], antrean: [] };

    function init() {
        document.getElementById('in-tgl').valueAsDate = new Date();
        const s = db.settings;
        document.getElementById('disp-nama').innerText = s.nama;
        document.getElementById('s-nama').value = s.nama;
        document.getElementById('s-alamat').value = s.alamat;
        document.getElementById('s-hp').value = s.hp;
        document.getElementById('s-owner').value = s.owner;
        document.getElementById('s-rek').value = s.rek;
        document.getElementById('s-prefix').value = s.prefix;
        document.getElementById('s-next-no').value = s.nextNo;
        document.getElementById('s-gsheet').value = s.gsheet;
        updateNotaDisplay(); addItemRow();
    }

    function updateNotaDisplay() { document.getElementById('in-nota').value = db.settings.prefix + String(db.settings.nextNo).padStart(3, '0'); }

    function addItemRow(data = {j:'', p:'', h:0, q:1}) {
        const div = document.createElement('div'); div.className = "grid-item item-row";
        div.innerHTML = `<input type="text" class="i-jasa" value="${data.j}" placeholder="Jasa"><input type="text" class="i-part" value="${data.p}" placeholder="Part"><input type="number" class="i-price" value="${data.h}"><input type="number" class="i-qty" value="${data.q}"><input type="text" readonly class="i-sub bg-gray-50 text-right font-bold" value="0"><button onclick="this.parentElement.remove(); recalc()" class="text-red-500 font-bold">Ã—</button>`;
        document.getElementById('item-list').appendChild(div); recalc();
    }

    function recalc() {
        let grand = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            const sub = h * q;
            row.querySelector('.i-sub').value = sub.toLocaleString('id-ID');
            grand += sub;
        });
        document.getElementById('grand-total').innerText = grand.toLocaleString('id-ID');
    }

    function prosesTransaksi() {
        const tipe = document.getElementById('in-tipe').value;
        const nopol = document.getElementById('in-nopol').value.toUpperCase();
        if(!nopol) return alert("Nopol Wajib Diisi!");

        let items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const j = row.querySelector('.i-jasa').value;
            const p = row.querySelector('.i-part').value;
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            if(j || p) items.push({j, p, h, q, s:h*q});
        });

        const jasa = items.filter(i => i.j);
        const part = items.filter(i => i.p);
        const sortedItems = [...jasa, ...part];
        const s = db.settings;
        const common = { tgl: document.getElementById('in-tgl').value, noTrx: document.getElementById('in-nota').value, nopol, km: document.getElementById('in-km').value, merk: document.getElementById('in-merk').value, nama: document.getElementById('in-nama').value, catatan: document.getElementById('in-catatan').value };

        if(tipe === "NOTA") {
            let batchData = [];
            sortedItems.forEach(i => {
                const row = {...common, uraian: i.j, sparepart: i.p, harga: i.h, qty: i.q, jumlah: i.s};
                db.transaksi.push(row);
                batchData.push(row);
            });
            if(s.gsheet) fetch(s.gsheet, { method:'POST', mode:'no-cors', body: JSON.stringify(batchData) });
            db.settings.nextNo++;
        } else {
            db.antrean.push({...common, items: sortedItems, tipe, total: document.getElementById('grand-total').innerText });
        }

        renderCetak(jasa, part, tipe);
        localStorage.setItem(KEY, JSON.stringify(db));
        window.print();
        setTimeout(() => location.reload(), 500);
    }

    function renderCetak(jasa, part, tipe) {
        let h = ""; const isWO = (tipe === "WO");
        if(jasa.length > 0){ h += `<tr class="cat-row"><td colspan="4">JASA / SERVICE</td></tr>`; jasa.forEach(i => { h += `<tr><td>${i.j}</td><td class="text-right p-harga-col" style="${isWO ? 'display:none':''}">${i.h.toLocaleString()}</td><td class="text-center">${i.q}</td><td class="text-right p-harga-col" style="${isWO ? 'display:none':''}">${i.s.toLocaleString()}</td></tr>`; }); }
        if(part.length > 0){ h += `<tr class="cat-row"><td colspan="4">SPAREPART / OLI</td></tr>`; part.forEach(i => { h += `<tr><td>${i.p}</td><td class="text-right p-harga-col" style="${isWO ? 'display:none':''}">${i.h.toLocaleString()}</td><td class="text-center">${i.q}</td><td class="text-right p-harga-col" style="${isWO ? 'display:none':''}">${i.s.toLocaleString()}</td></tr>`; }); }
        document.getElementById('p-body').innerHTML = h;
        const s = db.settings;
        document.getElementById('p-toko').innerText = s.nama;
        document.getElementById('p-alamat-toko').innerText = s.alamat;
        document.getElementById('p-hp-toko').innerText = "WA: " + s.hp;
        document.getElementById('p-owner').innerText = s.owner;
        document.getElementById('p-rek').innerText = s.rek;
        document.getElementById('p-label-tipe').innerText = tipe;
        document.getElementById('p-unit').innerText = document.getElementById('in-merk').value;
        document.getElementById('p-nopol').innerText = document.getElementById('in-nopol').value.toUpperCase();
        document.getElementById('p-km').innerText = document.getElementById('in-km').value;
        document.getElementById('p-no').innerText = document.getElementById('in-nota').value;
        document.getElementById('p-tgl').innerText = document.getElementById('in-tgl').value;
        document.getElementById('p-cat').innerText = document.getElementById('in-catatan').value;
        document.getElementById('p-total').innerText = document.getElementById('grand-total').innerText;
        document.querySelectorAll('.p-harga-col').forEach(el => el.style.display = isWO ? 'none' : 'table-cell');
        document.getElementById('p-foot-total').style.display = isWO ? 'none' : 'table-footer-group';
    }

    function renderRiwayat() {
        const s = document.getElementById('f-search').value.toLowerCase();
        const f = db.transaksi.filter(x => (x.nopol + x.noTrx + (x.nama||'')).toLowerCase().includes(s));
        document.getElementById('tbody-riwayat').innerHTML = f.slice().reverse().map(x => `<tr><td>${x.tgl}</td><td>${x.noTrx}</td><td>${x.nopol}</td><td>${x.km}</td><td>${x.merk}</td><td>${x.nama}</td><td>${x.uraian || ''}</td><td>${x.sparepart || ''}</td><td>${(x.harga||0).toLocaleString()}</td><td>${x.qty}</td><td>${(x.jumlah||0).toLocaleString()}</td><td>${x.catatan || '-'}</td></tr>`).join('');
    }

    function renderAntrean() {
        const list = document.getElementById('list-antrean'); list.innerHTML = "";
        db.antrean.forEach((a, idx) => {
            const div = document.createElement('div'); div.className = "card border-l-4 " + (a.tipe === 'WO' ? 'border-orange-500' : 'border-blue-500');
            div.innerHTML = `<div class="flex justify-between font-bold text-xs"><span>${a.tipe} - ${a.noTrx}</span><span>${a.tgl}</span></div><div class="my-1 font-black text-lg">${a.nopol} / ${a.merk}</div><div class="text-[10px] text-gray-600">Pelanggan: ${a.nama || '-'} | KM: ${a.km || '-'}</div><div class="text-[10px] bg-gray-100 p-1 mt-2 rounded">${a.catatan || 'Tidak ada catatan'}</div><div class="mt-2 text-right text-blue-700 font-bold">Total: Rp ${a.total}</div><div class="grid grid-cols-2 gap-2 mt-2"><button onclick="loadAntrean(${idx})" class="bg-green-600 text-white py-2 rounded text-[10px] font-bold uppercase">Proses Jadi Nota</button><button onclick="hapusAntrean(${idx})" class="bg-red-500 text-white py-2 rounded text-[10px] font-bold uppercase">Hapus</button></div>`;
            list.appendChild(div);
        });
    }

    function loadAntrean(idx) {
        const a = db.antrean[idx];
        document.getElementById('in-nopol').value = a.nopol;
        document.getElementById('in-merk').value = a.merk;
        document.getElementById('in-nama').value = a.nama;
        document.getElementById('in-km').value = a.km;
        document.getElementById('in-catatan').value = a.catatan;
        document.getElementById('in-tipe').value = "NOTA";
        document.getElementById('item-list').innerHTML = `<div class="grid-item text-[10px] font-black text-blue-900 uppercase mb-2 border-b pb-1 text-center"><div>Jasa</div><div>Part</div><div>Harga</div><div>Qty</div><div>Total</div><div></div></div>`;
        a.items.forEach(i => addItemRow(i));
        db.antrean.splice(idx, 1); localStorage.setItem(KEY, JSON.stringify(db)); showView('nota', document.querySelectorAll('.nav-btn')[0]);
    }

    function hapusAntrean(idx) { if(confirm("Hapus antrean ini?")) { db.antrean.splice(idx, 1); localStorage.setItem(KEY, JSON.stringify(db)); renderAntrean(); } }

    function renderLaporan() {
        const box = document.getElementById('box-laporan');
        let jasa = 0, part = 0;
        db.transaksi.forEach(t => { if(t.uraian) jasa += t.jumlah; if(t.sparepart) part += t.jumlah; });
        box.innerHTML = `<div class="card bg-blue-900 text-white text-center"><p class="text-xs uppercase opacity-70">Total Omzet</p><h3 class="text-3xl font-black font-mono">Rp ${(jasa + part).toLocaleString()}</h3></div><div class="grid grid-cols-2 gap-2"><div class="card border-t-4 border-blue-500"><p class="text-[10px] uppercase text-gray-500">Omzet Jasa</p><p class="text-lg font-bold text-blue-700">Rp ${jasa.toLocaleString()}</p></div><div class="card border-t-4 border-green-500"><p class="text-[10px] uppercase text-gray-500">Omzet Part</p><p class="text-lg font-bold text-green-700">Rp ${part.toLocaleString()}</p></div></div>`;
    }

    function showView(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.add('hidden'));
        document.getElementById('menu-' + v).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(v === 'riwayat') renderRiwayat();
        if(v === 'antrean') renderAntrean();
        if(v === 'laporan') renderLaporan();
    }

    function saveSettings() {
        db.settings = { nama: document.getElementById('s-nama').value.toUpperCase(), alamat: document.getElementById('s-alamat').value, hp: document.getElementById('s-hp').value, owner: document.getElementById('s-owner').value, rek: document.getElementById('s-rek').value, prefix: document.getElementById('s-prefix').value, nextNo: parseInt(document.getElementById('s-next-no').value) || 1, gsheet: document.getElementById('s-gsheet').value };
        localStorage.setItem(KEY, JSON.stringify(db)); alert("Saved!"); location.reload();
    }
    
    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `backup_bengkel_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }

    function importData(event) {
        const f = event.target.files[0]; if(!f) return;
        const r = new FileReader(); r.onload = (e) => { db = JSON.parse(e.target.result); localStorage.setItem(KEY, JSON.stringify(db)); location.reload(); }; r.readAsText(f);
    }

    function resetData() { if(confirm("Hapus Permanen Semua Data?")) { localStorage.clear(); location.reload(); } }

    init();
</script>
</body>
</html>
