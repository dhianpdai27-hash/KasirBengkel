<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengkel Pro - Master Final V15.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 90px; background: #f4f7fa; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; display: flex; background: #fff; border-top: 2px solid #ddd; z-index: 1000; }
        .nav-btn { flex: 1; padding: 12px 5px; text-align: center; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; }
        .nav-btn.active { color: #2563eb; border-top: 4px solid #2563eb; background: #f8fafc; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        input, select, textarea { border: 1px solid #ccc; padding: 10px; border-radius: 4px; width: 100%; font-size: 14px; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1100px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8fafc; color: #475569; position: sticky; top: 0; }
        .grid-item { display: grid; grid-template-columns: 2fr 2fr 1.5fr 0.8fr 1.5fr 40px; gap: 5px; margin-bottom: 8px; align-items: center; }

        @media print {
            .no-print, .nav-bottom, button, .bg-blue-900, .view { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            table { width: 100% !important; border: 1px solid black !important; min-width: 100% !important; }
            th, td { border: 1px solid black !important; padding: 6px !important; color: black !important; font-size: 12px !important; }
            .no-print-wo { display: none !important; }
            .category-row { background: #eee !important; font-weight: bold !important; text-transform: uppercase !important; }
        }
    </style>
</head>
<body>

<div class="bg-blue-900 text-white p-4 sticky top-0 flex justify-between items-center no-print z-50">
    <h1 id="disp-nama" class="font-bold uppercase italic text-xl">BENGKEL PRO</h1>
    <div class="text-[9px] bg-green-600 px-2 py-1 rounded uppercase font-bold">V15.8 MASTER</div>
</div>

<div class="p-4 no-print">
    <div id="menu-nota" class="view">
        <div class="card">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="in-tipe" class="font-bold text-blue-700 bg-blue-50">
                    <option value="NOTA">NOTA (OMZET)</option>
                    <option value="WO">WORKING ORDER</option>
                    <option value="ESTIMASI">ESTIMASI</option>
                </select>
                <input type="text" id="in-nota" readonly class="bg-gray-100 font-bold text-center">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" id="in-tgl">
                <input type="text" id="in-nopol" placeholder="NO POLISI" class="uppercase font-bold">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="in-nama" placeholder="NAMA CUSTOMER">
                <input type="text" id="in-merk" placeholder="MERK MOBIL">
            </div>
            <input type="number" id="in-km" placeholder="KILOMETER (KM)">
        </div>

        <div class="card">
            <div id="item-list" oninput="recalc()">
                <div class="grid-item text-[9px] font-bold text-gray-400 uppercase">
                    <div>Jasa</div><div>Part</div><div>Harga</div><div>Qty</div><div>Total</div><div></div>
                </div>
            </div>
            <button onclick="addItemRow()" class="text-blue-600 font-bold text-xs mt-2">+ TAMBAH ITEM</button>
            <textarea id="in-catatan" rows="2" placeholder="Catatan/Keluhan..." class="mt-4 text-xs w-full"></textarea>
            <div class="mt-4 p-4 bg-slate-900 text-white rounded flex justify-between items-center">
                <span id="grand-total" class="text-2xl font-mono text-green-400 font-bold">0</span>
            </div>
        </div>
        <button onclick="prosesTransaksi()" class="w-full bg-blue-700 text-white py-4 rounded-xl font-black shadow-lg">SIMPAN & CETAK</button>
    </div>

    <div id="menu-antrean" class="view hidden">
        <h2 class="font-bold text-blue-800 mb-3 uppercase italic text-sm">Antrean WO & Estimasi</h2>
        <div id="list-antrean" class="space-y-2"></div>
    </div>

    <div id="menu-riwayat" class="view hidden">
        <input type="text" id="f-search" placeholder="Cari Riwayat..." oninput="renderRiwayat()" class="w-full mb-2">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tgl</th><th>Nota</th><th>Nopol</th><th>Nama</th><th>Merk</th><th>Jasa</th><th>Part</th><th>Harga</th><th>Qty</th><th>Jumlah</th><th>Catatan</th>
                    </tr>
                </thead>
                <tbody id="tbody-riwayat"></tbody>
            </table>
        </div>
    </div>

    <div id="menu-laporan" class="view hidden">
        <div id="box-laporan" class="space-y-4"></div>
    </div>

    <div id="menu-setting" class="view hidden">
        <div class="card space-y-2">
            <label class="text-[10px] font-bold text-gray-400">PROFIL BENGKEL</label>
            <input type="text" id="s-nama" placeholder="Nama Bengkel">
            <input type="text" id="s-alamat" placeholder="Alamat">
            <input type="text" id="s-hp" placeholder="No HP">
            <input type="text" id="s-owner" placeholder="Owner">
            <input type="text" id="s-rek" placeholder="Rekening Pembayaran">
            <hr class="my-2 border-gray-100">
            <label class="text-[10px] font-bold text-orange-500 uppercase">Pengaturan Nomor Nota</label>
            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="s-prefix" placeholder="Prefix (DK012026-)">
                <input type="number" id="s-next-no" placeholder="No Urut (1)">
            </div>
            <hr class="my-2">
            <label class="text-[10px] font-bold text-blue-500 uppercase">Cloud Sync (Google Sheets)</label>
            <input type="text" id="s-gsheet" placeholder="URL Google Apps Script">
            <button onclick="saveSettings()" class="w-full bg-slate-800 text-white py-3 rounded font-bold mt-2 uppercase text-xs">Simpan Master Pengaturan</button>
        </div>

        <div class="card">
            <label class="text-[10px] font-bold text-gray-400 uppercase">Backup & Restore</label>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button onclick="exportData()" class="bg-green-600 text-white py-2 rounded text-[10px] font-bold uppercase">Export JSON</button>
                <button onclick="document.getElementById('importFile').click()" class="bg-orange-500 text-white py-2 rounded text-[10px] font-bold uppercase">Import JSON</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </div>
        
        <button onclick="resetData()" class="text-red-500 text-[10px] mt-8 block w-full text-center underline italic opacity-50">Hapus Data Lokal</button>
    </div>
</div>

<div id="print-area" class="hidden p-8 bg-white text-black">
    <div class="text-center border-b-4 border-double border-black pb-4 mb-4">
        <h2 id="p-toko" class="text-2xl font-bold uppercase"></h2>
        <p id="p-alamat-toko" class="text-xs"></p>
        <p id="p-hp-toko" class="text-xs"></p>
    </div>
    <div class="flex justify-between mb-4 text-[12px]">
        <div>
            <p>Unit: <span id="p-unit" class="font-bold"></span></p>
            <p>No. Polisi: <span id="p-nopol" class="font-bold"></span></p>
            <p>KM: <span id="p-km"></span></p>
        </div>
        <div class="text-right">
            <h2 id="p-label-tipe" class="font-bold underline text-lg italic uppercase"></h2>
            <p>No: <span id="p-no"></span></p>
            <p>Tgl: <span id="p-tgl"></span></p>
        </div>
    </div>
    <table class="w-full border border-black mb-4">
        <thead><tr class="bg-gray-100 italic">
            <th class="border border-black p-2">URAIAN PEKERJAAN / PART</th>
            <th class="border border-black p-2 text-right no-print-wo">HARGA</th>
            <th class="border border-black p-2 text-center">QTY</th>
            <th class="border border-black p-2 text-right no-print-wo">SUBTOTAL</th>
        </tr></thead>
        <tbody id="p-body"></tbody>
        <tfoot id="p-foot-total"><tr>
            <th colspan="3" class="text-right border border-black p-2 font-bold uppercase">Grand Total</th>
            <th class="text-right border border-black p-2 font-bold" id="p-total"></th>
        </tr></tfoot>
    </table>
    <div class="text-[12px] mb-2 font-bold">Catatan: <span id="p-cat" class="italic font-normal"></span></div>
    <div id="p-box-rek" class="text-[11px] mb-6 p-2 border border-dashed border-gray-400 bg-gray-50">
        Pembayaran Transfer: <span id="p-rek" class="font-bold"></span>
    </div>
    <div class="flex justify-between text-center mt-12 text-[12px]">
        <div class="w-40 border-t border-black pt-1"><p>Hormat Kami,</p><br><p>( <span id="p-owner"></span> )</p></div>
        <div class="w-40 border-t border-black pt-1"><p>Pelanggan,</p><br><p>( ............ )</p></div>
    </div>
</div>

<nav class="nav-bottom no-print">
    <div class="nav-btn active" onclick="showView('nota', this)">ENTRY</div>
    <div class="nav-btn" onclick="showView('antrean', this)">ANTREAN</div>
    <div class="nav-btn" onclick="showView('riwayat', this)">RIWAYAT</div>
    <div class="nav-btn" onclick="showView('laporan', this)">LAPORAN</div>
    <div class="nav-btn" onclick="showView('setting', this)">SETTING</div>
</nav>

<script>
    const KEY = "BENGKEL_PRO_V158_MASTER";
    let db = JSON.parse(localStorage.getItem(KEY)) || { 
        settings: { gsheet: "", nama: "BENGKEL PRO", rek: "", prefix: "DK012026-", nextNo: 1 }, 
        transaksi: [], 
        antrean: [] 
    };

    function init() {
        document.getElementById('in-tgl').valueAsDate = new Date();
        updateNotaDisplay();
        document.getElementById('disp-nama').innerText = db.settings.nama;
        document.getElementById('s-nama').value = db.settings.nama;
        document.getElementById('s-alamat').value = db.settings.alamat || "";
        document.getElementById('s-hp').value = db.settings.hp || "";
        document.getElementById('s-owner').value = db.settings.owner || "";
        document.getElementById('s-rek').value = db.settings.rek || "";
        document.getElementById('s-prefix').value = db.settings.prefix;
        document.getElementById('s-next-no').value = db.settings.nextNo;
        document.getElementById('s-gsheet').value = db.settings.gsheet;
        addItemRow();
    }

    function updateNotaDisplay() {
        const num = String(db.settings.nextNo).padStart(3, '0');
        document.getElementById('in-nota').value = db.settings.prefix + num;
    }

    function addItemRow(data = {j:'', p:'', h:0, q:1}) {
        const div = document.createElement('div'); div.className = "grid-item item-row";
        div.innerHTML = `
            <input type="text" class="i-jasa" value="${data.j}" placeholder="Jasa">
            <input type="text" class="i-part" value="${data.p}" placeholder="Part">
            <input type="number" class="i-price" value="${data.h}">
            <input type="number" class="i-qty" value="${data.q}">
            <input type="text" readonly class="i-sub bg-gray-50 text-right font-bold" value="0">
            <button onclick="this.parentElement.remove(); recalc()" class="text-red-500 font-bold">×</button>`;
        document.getElementById('item-list').appendChild(div);
        recalc();
    }

    function recalc() {
        let grand = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            const sub = h * q;
            row.querySelector('.i-sub').value = sub.toLocaleString();
            grand += sub;
        });
        document.getElementById('grand-total').innerText = grand.toLocaleString();
    }

    async function prosesTransaksi() {
        const tipe = document.getElementById('in-tipe').value;
        const nopol = document.getElementById('in-nopol').value.toUpperCase();
        if(!nopol) return alert("Nomor Polisi Wajib Diisi!");

        let jasaItems = []; let partItems = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const j = row.querySelector('.i-jasa').value;
            const p = row.querySelector('.i-part').value;
            const h = parseFloat(row.querySelector('.i-price').value) || 0;
            const q = parseFloat(row.querySelector('.i-qty').value) || 0;
            if(j) jasaItems.push({ name: j, h, q, sub: h*q });
            if(p) partItems.push({ name: p, h, q, sub: h*q });
        });

        let rowsHtml = "";
        if(jasaItems.length > 0) {
            rowsHtml += `<tr class="category-row"><td colspan="4" class="p-2 border border-black bg-gray-100 font-bold">JASA / SERVICE</td></tr>`;
            jasaItems.forEach(it => {
                rowsHtml += `<tr><td class="border border-black p-2 text-xs">${it.name}</td><td class="border border-black p-2 text-right text-xs no-print-wo">${it.h.toLocaleString()}</td><td class="border border-black p-2 text-center text-xs">${it.q}</td><td class="border border-black p-2 text-right text-xs no-print-wo">${it.sub.toLocaleString()}</td></tr>`;
            });
        }
        if(partItems.length > 0) {
            rowsHtml += `<tr class="category-row"><td colspan="4" class="p-2 border border-black bg-gray-100 font-bold">SPAREPART</td></tr>`;
            partItems.forEach(it => {
                rowsHtml += `<tr><td class="border border-black p-2 text-xs">${it.name}</td><td class="border border-black p-2 text-right text-xs no-print-wo">${it.h.toLocaleString()}</td><td class="border border-black p-2 text-center text-xs">${it.q}</td><td class="border border-black p-2 text-right text-xs no-print-wo">${it.sub.toLocaleString()}</td></tr>`;
            });
        }

        if(tipe === "WO") {
            document.querySelectorAll('.no-print-wo').forEach(el => el.style.display = 'none');
            document.getElementById('p-foot-total').style.display = 'none';
            document.getElementById('p-box-rek').style.display = 'none';
        } else {
            document.querySelectorAll('.no-print-wo').forEach(el => el.style.display = 'table-cell');
            document.getElementById('p-foot-total').style.display = 'table-footer-group';
            document.getElementById('p-box-rek').style.display = 'block';
        }

        document.getElementById('p-toko').innerText = db.settings.nama;
        document.getElementById('p-alamat-toko').innerText = db.settings.alamat;
        document.getElementById('p-hp-toko').innerText = "HP: " + db.settings.hp;
        document.getElementById('p-owner').innerText = db.settings.owner;
        document.getElementById('p-rek').innerText = db.settings.rek;
        document.getElementById('p-label-tipe').innerText = tipe;
        document.getElementById('p-unit').innerText = document.getElementById('in-merk').value;
        document.getElementById('p-nopol').innerText = nopol;
        document.getElementById('p-km').innerText = document.getElementById('in-km').value;
        document.getElementById('p-no').innerText = document.getElementById('in-nota').value;
        document.getElementById('p-tgl').innerText = document.getElementById('in-tgl').value;
        document.getElementById('p-cat').innerText = document.getElementById('in-catatan').value;
        document.getElementById('p-body').innerHTML = rowsHtml;
        document.getElementById('p-total').innerText = document.getElementById('grand-total').innerText;

        const common = { tgl: document.getElementById('in-tgl').value, noTrx: document.getElementById('in-nota').value, nopol: nopol, nama: document.getElementById('in-nama').value, merk: document.getElementById('in-merk').value, catatan: document.getElementById('in-catatan').value };

        if(tipe === "NOTA") {
            jasaItems.forEach(it => {
                const p = { ...common, uraian: it.name, sparepart: "", harga: it.h, qty: it.q, jumlah: it.sub };
                db.transaksi.push(p);
                if(db.settings.gsheet) fetch(db.settings.gsheet, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
            });
            partItems.forEach(it => {
                const p = { ...common, uraian: "", sparepart: it.name, harga: it.h, qty: it.q, jumlah: it.sub };
                db.transaksi.push(p);
                if(db.settings.gsheet) fetch(db.settings.gsheet, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
            });
            db.settings.nextNo++;
        } else {
            const allItems = [...jasaItems.map(i=>({j:i.name, p:"", h:i.h, q:i.q})), ...partItems.map(i=>({j:"", p:i.name, h:i.h, q:i.q}))];
            db.antrean.push({...common, items: allItems, tipe, total: document.getElementById('grand-total').innerText});
        }

        localStorage.setItem(KEY, JSON.stringify(db));
        window.print();
        setTimeout(() => { location.reload(); }, 500);
    }

    function renderRiwayat() {
        const s = document.getElementById('f-search').value.toLowerCase();
        const f = db.transaksi.filter(x => (x.nopol + x.nama + x.noTrx).toLowerCase().includes(s));
        document.getElementById('tbody-riwayat').innerHTML = f.slice().reverse().map(x => `<tr><td>${x.tgl}</td><td>${x.noTrx}</td><td>${x.nopol}</td><td>${x.nama}</td><td>${x.merk}</td><td>${x.uraian}</td><td>${x.sparepart}</td><td>${x.harga.toLocaleString()}</td><td>${x.qty}</td><td>${x.jumlah.toLocaleString()}</td><td>${x.catatan || '-'}</td></tr>`).join('');
    }

    function renderLaporan() {
        const tJasa = db.transaksi.filter(x => x.uraian !== "").reduce((a,c) => a + (parseFloat(c.jumlah)||0), 0);
        const tPart = db.transaksi.filter(x => x.sparepart !== "").reduce((a,c) => a + (parseFloat(c.jumlah)||0), 0);
        document.getElementById('box-laporan').innerHTML = `<div class="card border-l-8 border-blue-600"><p class="text-[10px] font-bold uppercase">Laporan Jasa</p><h2 class="text-2xl font-black text-blue-700">Rp ${tJasa.toLocaleString()}</h2></div><div class="card border-l-8 border-green-600"><p class="text-[10px] font-bold uppercase">Laporan Sparepart</p><h2 class="text-2xl font-black text-green-700">Rp ${tPart.toLocaleString()}</h2></div><div class="card bg-slate-900 text-white"><p class="text-[10px] opacity-70 italic uppercase">Total Omzet</p><h2 class="text-3xl font-black text-green-400">Rp ${(tJasa+tPart).toLocaleString()}</h2></div>`;
    }

    function renderAntrean() {
        document.getElementById('list-antrean').innerHTML = db.antrean.map(x => `<div class="card flex justify-between items-center border-l-4 border-orange-500"><div><b class="text-blue-700">${x.nopol}</b> - ${x.nama} (${x.tipe})<br><small>Total: ${x.total}</small></div><div class="flex gap-2"><button onclick="loadAntrean('${x.noTrx}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold uppercase">Proses</button><button onclick="hapusAntrean('${x.noTrx}')" class="text-red-500 text-xs font-bold">×</button></div></div>`).join('') || '<p class="text-center italic text-gray-400">Antrean Kosong</p>';
    }

    function loadAntrean(noTrx) {
        const x = db.antrean.find(i => i.noTrx === noTrx); if(!x) return;
        document.getElementById('in-nopol').value = x.nopol;
        document.getElementById('in-nama').value = x.nama;
        document.getElementById('in-merk').value = x.merk;
        document.getElementById('in-catatan').value = x.catatan;
        document.getElementById('item-list').innerHTML = '<div class="grid-item text-[9px] font-bold text-gray-400 uppercase"><div>Jasa</div><div>Part</div><div>Harga</div><div>Qty</div><div>Total</div><div></div></div>';
        x.items.forEach(it => addItemRow({j: it.j, p: it.p, h: it.h, q: it.q}));
        db.antrean = db.antrean.filter(i => i.noTrx !== noTrx);
        localStorage.setItem(KEY, JSON.stringify(db));
        showView('nota', document.querySelectorAll('.nav-btn')[0]);
    }

    function saveSettings() {
        db.settings = { nama: document.getElementById('s-nama').value.toUpperCase(), alamat: document.getElementById('s-alamat').value, hp: document.getElementById('s-hp').value, owner: document.getElementById('s-owner').value, rek: document.getElementById('s-rek').value, prefix: document.getElementById('s-prefix').value, nextNo: parseInt(document.getElementById('s-next-no').value) || 1, gsheet: document.getElementById('s-gsheet').value };
        localStorage.setItem(KEY, JSON.stringify(db));
        alert("Master Settings Saved!"); location.reload();
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `backup_bengkel_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                db = JSON.parse(e.target.result);
                localStorage.setItem(KEY, JSON.stringify(db));
                alert("Data Berhasil Direstore!"); location.reload();
            } catch(err) { alert("File tidak valid!"); }
        };
        reader.readAsText(file);
    }

    function showView(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.add('hidden'));
        document.getElementById('menu-' + v).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(v === 'antrean') renderAntrean();
        if(v === 'riwayat') renderRiwayat();
        if(v === 'laporan') renderLaporan();
    }

    function hapusAntrean(noTrx) { if(confirm("Hapus?")) { db.antrean = db.antrean.filter(i => i.noTrx !== noTrx); localStorage.setItem(KEY, JSON.stringify(db)); renderAntrean(); } }
    function resetData() { if(confirm("Reset data lokal?")) { localStorage.clear(); location.reload(); } }
    init();
</script>
</body>
</html>
