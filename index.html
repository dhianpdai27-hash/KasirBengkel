<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengkel Pro v3.8 - Full History & Validated Import</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #e67e22; --success: #27ae60; --danger: #c0392b; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: var(--light); color: #333; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; border-bottom: 4px solid var(--accent); }
        nav { background: var(--secondary); display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; position: sticky; top: 0; z-index: 100; }
        button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 5px; background: var(--accent); color: white; font-weight: bold; transition: 0.3s; }
        .container { padding: 20px; max-width: 100%; margin: auto; }
        .section { display: none; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .active { display: block; }
        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: var(--secondary); }
        input, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; text-align: left; }
        td { padding: 8px; border: 1px solid #dee2e6; vertical-align: top; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        .badge-pol { background: #34495e; color: #f1c40f; padding: 2px 4px; border-radius: 3px; font-weight: bold; font-family: monospace; }
        .card-report { padding: 20px; border-radius: 8px; color: white; text-align: center; }
        .bg-in { background: #27ae60; } .bg-out { background: #e74c3c; } .bg-net { background: #2980b9; }
        #printArea { display: none; }
    </style>
</head>
<body>

<header class="no-print">
    <h1 id="dispNama">Bengkel Pro</h1>
    <p id="dispAlamat">Alamat Bengkel</p>
</header>

<nav class="no-print">
    <button onclick="showSection('transaksi')">üìù Kasir Baru</button>
    <button onclick="showSection('riwayat')">üïí Riwayat Rinci</button>
    <button onclick="showSection('pengeluaran')">üí∏ Pengeluaran</button>
    <button onclick="showSection('laporan')">üìä Laporan</button>
    <button onclick="showSection('settings')">‚öôÔ∏è Pengaturan</button>
</nav>

<div class="container no-print">
    <div id="transaksi" class="section active">
        <h2>Nota Transaksi Baru</h2>
        <div class="form-group">
            <div><label>No. Nota</label><input type="text" id="noNota" readonly style="background:#eee"></div>
            <div><label>Tanggal</label><input type="date" id="tglTrx"></div>
            <div><label>Customer Nama</label><input type="text" id="custNama"></div>
            <div><label>No. Polisi</label><input type="text" id="noPol"></div>
            <div><label>Mobil / KM</label><input type="text" id="mobilKm"></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Uraian Jasa / Sparepart</th>
                    <th style="width: 80px;">Qty</th>
                    <th>Harga Satuan</th>
                    <th style="width: 150px;">Subtotal</th>
                    <th style="width: 40px;">#</th>
                </tr>
            </thead>
            <tbody id="inputBody"></tbody>
        </table>
        <button onclick="addRow()" style="margin-top:10px; background:#3498db;">+ Tambah Item</button>
        <div style="margin-top:20px;"><label>Catatan Khusus:</label><textarea id="catatanTrx" rows="2" placeholder="Catatan pekerjaan..."></textarea></div>
        <div style="text-align:right; font-size:1.5rem; font-weight:bold; margin-top:15px;" id="dispTotal">Total: Rp 0</div>
        <button onclick="processSaveAndPrint()" style="margin-top:20px; background:var(--success); width: 100%; padding: 15px;">üíæ SIMPAN & CETAK RAWBT</button>
    </div>

    <div id="riwayat" class="section">
        <h2>Riwayat Pekerjaan Terperinci</h2>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="searchFilter" onkeyup="filterRiwayat()" placeholder="Cari Nama, Plat, atau Uraian..." style="flex:1">
            <input type="date" id="filterTgl" onchange="filterRiwayat()">
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Customer</th>
                        <th>No. Pol</th>
                        <th>Mobil/KM</th>
                        <th>Uraian</th>
                        <th>Qty</th>
                        <th>Harga</th>
                        <th>Catatan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="riwayatBody"></tbody>
            </table>
        </div>
    </div>

    <div id="pengeluaran" class="section">
        <h2>Input Pengeluaran</h2>
        <div class="form-group">
            <input type="date" id="tglKeluar">
            <input type="text" id="ketKeluar" placeholder="Keterangan">
            <input type="number" id="nomKeluar" placeholder="Nominal Rp">
            <button onclick="addPengeluaran()" style="background:var(--success);">Simpan</button>
        </div>
        <table>
            <tbody id="keluarBody"></tbody>
        </table>
    </div>

    <div id="laporan" class="section">
        <h2>Laporan Keuangan</h2>
        <input type="month" id="filterBulan" onchange="runLaporan()">
        <div class="form-group" style="margin-top:20px">
            <div class="card-report bg-in">Pemasukan<br><h3 id="repIn">Rp 0</h3></div>
            <div class="card-report bg-out">Pengeluaran<br><h3 id="repOut">Rp 0</h3></div>
            <div class="card-report bg-net">Laba Bersih<br><h3 id="repNet">Rp 0</h3></div>
        </div>
    </div>

    <div id="settings" class="section">
        <h2>Pengaturan Profil & Rekening</h2>
        <div class="form-group">
            <div><label>Nama Bengkel</label><input type="text" id="setNama"></div>
            <div><label>Alamat</label><input type="text" id="setAlamat"></div>
            <div><label>WA</label><input type="text" id="setWA"></div>
            <div><label>Rekening</label><input type="text" id="setRek"></div>
            <div><label>Pemilik (TTD)</label><input type="text" id="setOwner"></div>
        </div>
        <button onclick="saveSettings()" style="background:var(--success);">Simpan</button>
        <hr style="margin:30px 0;">
        <h3>Manajemen Data (Gunakan File Excel .xlsx)</h3>
        <div style="display:flex; gap:10px;">
            <button onclick="exportExcel()" style="background:#2980b9;">üì• Backup ke Excel</button>
            <input type="file" id="importFile" style="display:none" accept=".xlsx, .xls" onchange="handleImport(event)">
            <button onclick="document.getElementById('importFile').click()" style="background:#8e44ad;">üì§ Import dari Excel</button>
            <button onclick="resetData()" style="background:var(--danger)">üóëÔ∏è Reset Data</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
    const STORAGE_KEY = 'DB_BENGKEL_V3_FINAL_DETAILED';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        config: { name: 'Bengkel Anda', addr: 'Alamat', wa: '08123', rek: '-', owner: 'Owner' },
        trxs: [], exps: []
    };

    window.onload = () => { initUI(); refreshUI(); runLaporan(); };

    function initUI() {
        document.getElementById('dispNama').innerText = db.config.name;
        document.getElementById('dispAlamat').innerText = db.config.addr;
        document.getElementById('setNama').value = db.config.name;
        document.getElementById('setAlamat').value = db.config.addr;
        document.getElementById('setWA').value = db.config.wa;
        document.getElementById('setRek').value = db.config.rek;
        document.getElementById('setOwner').value = db.config.owner;
        document.getElementById('tglTrx').valueAsDate = new Date();
        document.getElementById('tglKeluar').valueAsDate = new Date();
        document.getElementById('filterBulan').value = new Date().toISOString().slice(0, 7);
        generateNotaOtomatis();
        if(document.getElementById('inputBody').innerHTML === "") addRow();
    }

    function generateNotaOtomatis() {
        const d = new Date();
        const prefix = `${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
        const count = db.trxs.filter(t => t.nota.startsWith(prefix)).length;
        document.getElementById('noNota').value = `${prefix}-${String(count + 1).padStart(4, '0')}`;
    }

    function addRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="i-desc"></td><td><input type="number" class="i-qty" value="1" oninput="calcTotal()"></td><td><input type="number" class="i-prc" value="0" oninput="calcTotal()"></td><td class="i-sub" style="text-align:right">0</td><td><button onclick="this.parentElement.parentElement.remove(); calcTotal()" style="background:red; color:white">X</button></td>`;
        document.getElementById('inputBody').appendChild(tr);
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('#inputBody tr').forEach(r => {
            const q = r.querySelector('.i-qty').value || 0;
            const p = r.querySelector('.i-prc').value || 0;
            const sub = q * p;
            r.querySelector('.i-sub').innerText = sub.toLocaleString('id-ID');
            total += sub;
        });
        document.getElementById('dispTotal').innerText = "Total: Rp " + total.toLocaleString('id-ID');
    }

    function refreshUI() {
        const rb = document.getElementById('riwayatBody'); rb.innerHTML = '';
        const sorted = [...db.trxs].sort((a, b) => new Date(b.tgl) - new Date(a.tgl));
        sorted.forEach(t => {
            const items = JSON.parse(t.items || "[]");
            items.forEach((it, idx) => {
                const tr = document.createElement('tr');
                if(idx === 0) tr.style.borderTop = "2px solid #2c3e50";
                tr.innerHTML = `
                    <td>${idx === 0 ? t.tgl : ''}</td>
                    <td>${idx === 0 ? t.cust : ''}</td>
                    <td>${idx === 0 ? `<span class="badge-pol">${t.pol}</span>` : ''}</td>
                    <td>${idx === 0 ? t.unit : ''}</td>
                    <td style="background:#fffef0">${it.d}</td>
                    <td style="text-align:center">${it.q}</td>
                    <td style="text-align:right">${parseInt(it.p).toLocaleString()}</td>
                    <td>${idx === 0 ? (t.note || '-') : ''}</td>
                    <td>${idx === 0 ? `<button onclick="reprint('${t.nota}')" style="background:#27ae60; padding:2px 5px; font-size:10px">Cetak</button>` : ''}</td>
                `;
                rb.appendChild(tr);
            });
        });
        const eb = document.getElementById('keluarBody'); eb.innerHTML = '';
        db.exps.slice().reverse().forEach((e, i) => {
            eb.innerHTML += `<tr><td>${e.tgl}</td><td>${e.ket}</td><td>${e.nom.toLocaleString()}</td><td><button onclick="delExp(${db.exps.length - 1 - i})" style="background:red; color:white">X</button></td></tr>`;
        });
    }

    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                const dataTrx = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Validasi apakah ini file bengkel atau bukan
                if (dataTrx.length > 0 && !dataTrx[0].nota && !dataTrx[0].Nota) {
                    throw new Error("File ini bukan data Bengkel atau format kolom salah.");
                }

                let imported = 0;
                dataTrx.forEach(row => {
                    const clean = { 
                        nota: row.nota || row.Nota || row["No. Nota"], 
                        tgl: row.tgl || row.Tanggal, 
                        cust: row.cust || row.Customer, 
                        pol: row.pol || row["No. Polisi"], 
                        unit: row.unit || row["Mobil / KM"], 
                        note: row.note || row.Catatan, 
                        total: parseInt(row.total || row.Total || 0), 
                        items: row.items || "[]" 
                    };
                    if(clean.nota && !db.trxs.find(x => x.nota === clean.nota)) {
                        db.trxs.push(clean);
                        imported++;
                    }
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                alert(imported > 0 ? `Berhasil mengimpor ${imported} data baru.` : "Tidak ada data baru yang ditambahkan.");
                location.reload();
            } catch (err) {
                alert("Gagal Import: " + err.message);
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function processSaveAndPrint() {
        const items = [];
        document.querySelectorAll('#inputBody tr').forEach(r => {
            const d = r.querySelector('.i-desc').value;
            const q = r.querySelector('.i-qty').value;
            const p = r.querySelector('.i-prc').value;
            if(d) items.push({ d, q, p });
        });
        if(items.length === 0) return alert("Isi item!");
        const nota = {
            nota: document.getElementById('noNota').value,
            tgl: document.getElementById('tglTrx').value,
            cust: document.getElementById('custNama').value,
            pol: document.getElementById('noPol').value.toUpperCase(),
            unit: document.getElementById('mobilKm').value,
            note: document.getElementById('catatanTrx').value,
            total: items.reduce((a, b) => a + (b.q * b.p), 0),
            items: JSON.stringify(items)
        };
        db.trxs.push(nota);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        reprint(nota.nota);
        setTimeout(() => location.reload(), 1200);
    }

    function reprint(no) {
        const t = db.trxs.find(x => x.nota === no);
        if(!t) return;
        const items = JSON.parse(t.items);
        let rows = '';
        items.forEach(it => {
            rows += `<tr><td>${it.d}</td><td align="center">${it.q}</td><td align="right">${parseInt(it.p).toLocaleString()}</td><td align="right">${(it.q*it.p).toLocaleString()}</td></tr>`;
        });
        const printContent = `
            <div style="padding:40px; font-family:sans-serif; background:white;">
                <table width="100%">
                    <tr>
                        <td><h1 style="margin:0">${db.config.name}</h1><p style="margin:5px 0">${db.config.addr}</p><p style="margin:0">WA: ${db.config.wa}</p></td>
                        <td align="right"><h2>INVOICE</h2><p><b>${t.nota}</b></p></td>
                    </tr>
                </table>
                <hr>
                <p>Pelanggan: ${t.cust} | Nopol: ${t.pol} | Unit: ${t.unit} | Tgl: ${t.tgl}</p>
                <table width="100%" border="1" style="border-collapse:collapse; margin:20px 0;">
                    <thead><tr style="background:#eee"><th>Uraian</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <p>Catatan: ${t.note || '-'}</p>
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-size:14px; border:1px dashed #ccc; padding:10px;">
                        <b>Pembayaran:</b><br>Rekening: ${db.config.rek}
                    </div>
                    <div align="right"><h3>TOTAL: Rp ${t.total.toLocaleString()}</h3></div>
                </div>
                <div style="margin-top:50px; display:flex; justify-content:space-between; text-align:center;">
                    <div width="200">Pelanggan,<br><br><br>( ................. )</div>
                    <div width="200">Hormat Kami,<br><br><br>( ${db.config.owner} )</div>
                </div>
            </div>
        `;
        document.getElementById('printArea').innerHTML = printContent;
        window.location.href = "rawbt:base64," + btoa(unescape(encodeURIComponent(printContent)));
    }

    function saveSettings() {
        db.config = { name: document.getElementById('setNama').value, addr: document.getElementById('setAlamat').value, wa: document.getElementById('setWA').value, rek: document.getElementById('setRek').value, owner: document.getElementById('setOwner').value };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        alert("Profil disimpan!");
        location.reload();
    }

    function filterRiwayat() {
        const kw = document.getElementById('searchFilter').value.toLowerCase();
        const tgl = document.getElementById('filterTgl').value;
        document.querySelectorAll('#riwayatBody tr').forEach(row => {
            const txt = row.innerText.toLowerCase();
            row.style.display = (txt.includes(kw) && (!tgl || txt.includes(tgl))) ? "" : "none";
        });
    }

    function runLaporan() {
        const m = document.getElementById('filterBulan').value;
        const inc = db.trxs.filter(t => t.tgl.startsWith(m)).reduce((a, b) => a + b.total, 0);
        const out = db.exps.filter(e => e.tgl.startsWith(m)).reduce((a, b) => a + b.nom, 0);
        document.getElementById('repIn').innerText = "Rp " + inc.toLocaleString();
        document.getElementById('repOut').innerText = "Rp " + out.toLocaleString();
        document.getElementById('repNet').innerText = "Rp " + (inc - out).toLocaleString();
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.trxs), "DataTransaksi");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.exps), "DataPengeluaran");
        XLSX.writeFile(wb, "Backup_Bengkel_Pro.xlsx");
    }

    function addPengeluaran() {
        const p = { tgl: document.getElementById('tglKeluar').value, ket: document.getElementById('ketKeluar').value, nom: parseInt(document.getElementById('nomKeluar').value || 0) };
        if(p.ket) { db.exps.push(p); localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); location.reload(); }
    }

    function delExp(i) { db.exps.splice(i, 1); localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); location.reload(); }
    function resetData() { if(confirm("Hapus semua?")) { localStorage.clear(); location.reload(); } }
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
